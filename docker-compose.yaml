services:
  # 1. Go Controller Microservice (API & Proxy)
  controller_v2:
    build:
      context: .
      dockerfile: docker/controller_v2/Dockerfile
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: "postgresql://root@cockroachdb:26257/defaultdb?sslmode=disable"
      APP_ENV: "DEVELOPMENT"
      JUPYTER_GATEWAY_URL: "http://jupyter_gateway:8888"
      JUPYTER_AUTH_TOKEN: "YOUR_SECRET_TOKEN"
      CULL_INTERVAL_MINUTES: 10
      IDLE_THRESHOLD_MINUTES: 30
    networks:
      - evoc-net
    depends_on:
      cockroachdb:
        condition: service_started # Ensure DB is ready
      jupyter_gateway:
        condition: service_started
      minio:
        condition: service_started

  # 2. Jupyter Kernel Gateway (Manager)
  jupyter_gateway:
    # CRITICAL CHANGE: Build context points to its own folder.
    build:
      context: ./docker/jupyter_gateway
      dockerfile: Dockerfile
    environment:
      KG_AUTH_TOKEN: 'YOUR_SECRET_TOKEN'
      KG_ALLOW_ORIGIN: '*'
      KG_IP: '0.0.0.0'
      KG_PORT: 8888
    ports:
      - "8888:8888"
    networks:
      - evoc-net
    depends_on:
      python_runner:
        condition: service_started

  # 3. Python Runner (Worker Environment)
  python_runner:
    build:
      context: ./docker/python_runner
      dockerfile: Dockerfile
    networks:
      - evoc-net

  # 4. CockroachDB (Database) - Image remains the same
  cockroachdb:
    image: cockroachdb/cockroach:v22.2.0
    command: start-single-node --insecure --host=cockroachdb
    ports:
      - "26257:26257"
      - "8081:8081"
    volumes:
      - cockroach-data:/cockroach/cockroach-data
    networks:
      - evoc-net

  # 5. MinIO (Object Storage)
  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minio_user
      MINIO_ROOT_PASSWORD: minio_password
    networks:
      - evoc-net

# Define the shared network (Docker DNS)
networks:
  evoc-net:
    driver: bridge

# Define persistent storage volumes
volumes:
  cockroach-data:
